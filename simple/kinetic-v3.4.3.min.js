/**
 * KineticJS JavaScript Library v3.4.3
 * http://www.kineticjs.com/
 * Copyright 2012, Eric Rowell
 * Licensed under the MIT or GPL Version 2 licenses.
 * Date: Jan 4 2012
 *
 * Copyright (C) 2011 by Eric Rowell
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */
var Kinetic={};Kinetic.Layer=function(a,c){this.canvas=document.createElement("canvas");this.context=this.canvas.getContext("2d");this.canvas.width=a.width;this.canvas.height=a.height;this.canvas.style.position="absolute";this.shapes=[];if(c){var b=this;this.context.stroke=function(){};this.context.fill=function(){};this.context.fillRect=function(e,g,f,d){b.context.rect(e,g,f,d)};this.context.strokeRect=function(e,g,f,d){b.context.rect(e,g,f,d)};this.context.drawImage=function(){};this.context.fillText=function(){};this.context.strokeText=function(){}}a.container.appendChild(this.canvas)};Kinetic.Layer.prototype.clear=function(){var b=this.getContext();var a=this.getCanvas();b.clearRect(0,0,a.width,a.height)};Kinetic.Layer.prototype.getCanvas=function(){return this.canvas};Kinetic.Layer.prototype.getContext=function(){return this.context};Kinetic.Layer.prototype.getShapes=function(){return this.shapes};Kinetic.Layer.prototype.draw=function(){this.clear();var a=this.getContext();for(var b=0;b<this.getShapes().length;b++){this.getShapes()[b].draw(this)}};Kinetic.Layer.prototype.setZIndices=function(){var a=this.getShapes();for(var b=0;b<a.length;b++){a[b].zIndex=b}};Kinetic.Stage=function(b,d,a){this.container=document.getElementById(b);this.width=d;this.height=a;this.idCounter=0;this.dblClickWindow=400;this.mousePos=null;this.mouseDown=false;this.mouseUp=false;this.targetShape={};this.touchPos=null;this.touchStart=false;this.touchEnd=false;this.bufferLayer=new Kinetic.Layer(this);this.backstageLayer=new Kinetic.Layer(this,true);this.stageLayer=new Kinetic.Layer(this);this.propsLayer=new Kinetic.Layer(this);this.actorsLayer=new Kinetic.Layer(this);this.bufferLayer.getCanvas().style.display="none";this.backstageLayer.getCanvas().style.display="none";this.listen();this.addEventListener("mouseout",function(h){e.shapeDragging=undefined},false);var e=this;var c=[{end:"mouseup",move:"mousemove"},{end:"touchend",move:"touchmove"}];for(var g=0;g<c.length;g++){var f=c[g];(function(){var h=f;e.on(h.move,function(i){if(e.shapeDragging){var j=h.move=="mousemove"?e.getMousePos():e.getTouchPos();if(e.shapeDragging.drag.x){e.shapeDragging.x=j.x-e.shapeDragging.offset.x}if(e.shapeDragging.drag.y){e.shapeDragging.y=j.y-e.shapeDragging.offset.y}e.drawActors()}},false);e.on(h.end,function(j){if(e.shapeDragging){var m=e.shapeDragging.eventListeners.ondragend;if(m){var l=m;for(var k=0;k<l.length;k++){l[k].func.apply(e.shapeDragging,[j])}}}e.shapeDragging=undefined})})()}this.on("touchmove",function(h){if(e.shapeDragging){var i=e.getTouchPos();e.shapeDragging.x=i.x-e.shapeDragging.offset.x;e.shapeDragging.y=i.y-e.shapeDragging.offset.y;e.drawActors()}},false);this.on("touchend",function(h){if(e.shapeDragging){var l=e.shapeDragging.eventListeners.ondragend;if(l){var k=l;for(var j=0;j<k.length;j++){k[j].func.apply(e.shapeDragging,[h])}}}e.shapeDragging=undefined})};Kinetic.Stage.prototype.getBufferLayer=function(){return this.bufferLayer};Kinetic.Stage.prototype.getBackstageLayer=function(){return this.backstageLayer};Kinetic.Stage.prototype.getStageLayer=function(){return this.stageLayer};Kinetic.Stage.prototype.getPropsLayer=function(){return this.propsLayer};Kinetic.Stage.prototype.getActorsLayer=function(){return this.actorsLayer};Kinetic.Stage.prototype.clear=function(){this.stageLayer.clear()};Kinetic.Stage.prototype.clearAll=function(){this.backstageLayer.clear();this.stageLayer.clear();this.propsLayer.clear();this.actorsLayer.clear()};Kinetic.Stage.prototype.toDataURL=function(h){var b=this.getBufferLayer();var a=b.getContext();var d=this.getStageLayer();var g=this.getPropsLayer();var e=this.getActorsLayer();var f=[d,g,e];function c(k){var j=f[k].getCanvas().toDataURL();var i=new Image();i.onload=function(){a.drawImage(this,0,0);k++;if(k<f.length){c(k)}else{h(b.getCanvas().toDataURL())}};i.src=j}b.clear();c(0)};Kinetic.Stage.prototype.drawActors=function(){this.getActorsLayer().draw()};Kinetic.Stage.prototype.drawProps=function(){this.getPropsLayer().draw()};Kinetic.Stage.prototype.draw=function(){this.drawProps();this.drawActors()};Kinetic.Stage.prototype.remove=function(b){var a=this.getShapes();var c=b.getLayer();for(var e=0;e<a.length;e++){var d=a[e].id;if(d==b.id){b.getLayer().getShapes().splice(e,1)}}c.setZIndices()};Kinetic.Stage.prototype.removeAll=function(){this.getPropsLayer().shapes=[];this.getActorsLayer().shapes=[]};Kinetic.Stage.prototype.getCanvas=function(){return this.stageLayer.getCanvas()};Kinetic.Stage.prototype.getContext=function(){return this.stageLayer.getContext()};Kinetic.Stage.prototype.on=function(a,b){this.container.addEventListener(a,b)};Kinetic.Stage.prototype.addEventListener=function(a,b){this.on(a,b)};Kinetic.Stage.prototype.add=function(a){a.stage=this;if(a.isProp){a.layer=this.propsLayer}else{a.layer=this.actorsLayer}a.getLayer().shapes.push(a);a.id=this.idCounter++;a.zIndex=this.id;a.draw(a.layer)};Kinetic.Stage.prototype.handleEvent=function(a){if(!a){a=window.event}this.setMousePosition(a);this.setTouchPosition(a);var f=this.backstageLayer;var c=f.getContext();var d=this;f.clear();for(var e=this.getShapes().length-1;e>=0;e--){var b=this.getShapes()[e];(function(){var g=b;g.draw(f);var m=d.touchPos||d.mousePos;var l=g.eventListeners;if(g.visible&&m!==null&&c.isPointInPath(m.x,m.y)){if(d.mouseDown){d.mouseDown=false;g.clickStart=true;if(l.onmousedown){var k=l.onmousedown;for(var j=0;j<k.length;j++){k[j].func.apply(g,[a])}}e=-1}else{if(d.mouseUp){d.mouseUp=false;if(l.onmouseup){var k=l.onmouseup;for(var j=0;j<k.length;j++){k[j].func.apply(g,[a])}}if(g.clickStart){if(l.onclick){var k=l.onclick;for(var j=0;j<k.length;j++){k[j].func.apply(g,[a])}}if(l.ondblclick&&g.inDoubleClickWindow){var k=l.ondblclick;for(var j=0;j<k.length;j++){k[j].func.apply(g,[a])}}g.inDoubleClickWindow=true;setTimeout(function(){g.inDoubleClickWindow=false},d.dblClickWindow)}e=-1}else{if(d.touchStart){d.touchStart=false;if(l.touchstart){var k=l.touchstart;for(var j=0;j<k.length;j++){k[j].func.apply(g,[a])}}if(l.ondbltap&&g.inDoubleClickWindow){var k=l.ondbltap;for(var j=0;j<k.length;j++){k[j].func.apply(g,[a])}}g.inDoubleClickWindow=true;setTimeout(function(){g.inDoubleClickWindow=false},d.dblClickWindow);e=-1}else{if(d.touchEnd){d.touchEnd=false;if(l.touchend){var k=l.touchend;for(var j=0;j<k.length;j++){k[j].func.apply(g,[a])}}e=-1}else{if(l.touchmove){var k=l.touchmove;for(var j=0;j<k.length;j++){k[j].func.apply(g,[a])}e=-1}else{if(d.targetShape.id===undefined||(d.targetShape.id!=g.id&&d.targetShape.getZIndex()<g.getZIndex())){var h=d.targetShape.eventListeners;if(h&&h.onmouseout){var k=h.onmouseout;for(var j=0;j<k.length;j++){k[j].func.apply(g,[a])}}d.targetShape=g;if(l.onmouseover){var k=l.onmouseover;for(var j=0;j<k.length;j++){k[j].func.apply(g,[a])}}e=-1}else{if(l.onmousemove){var k=l.onmousemove;for(var j=0;j<k.length;j++){k[j].func.apply(g,[a])}e=-1}}}}}}}}else{if(d.targetShape.id==g.id){d.targetShape={};if(l.onmouseout){var k=l.onmouseout;for(var j=0;j<k.length;j++){k[j].func.apply(g,[a])}}e=-1}}}())}};Kinetic.Stage.prototype.listen=function(){var a=this;this.container.addEventListener("mousedown",function(b){a.mouseDown=true;a.handleEvent(b)},false);this.container.addEventListener("mousemove",function(b){a.mouseUp=false;a.mouseDown=false;a.handleEvent(b)},false);this.container.addEventListener("mouseup",function(b){a.mouseUp=true;a.mouseDown=false;a.handleEvent(b);for(var c=0;c<a.getShapes().length;c++){a.getShapes()[c].clickStart=false}},false);this.container.addEventListener("mouseover",function(b){a.handleEvent(b)},false);this.container.addEventListener("mouseout",function(b){a.mousePos=null},false);this.container.addEventListener("touchstart",function(b){b.preventDefault();a.touchStart=true;a.handleEvent(b)},false);this.container.addEventListener("touchmove",function(b){b.preventDefault();a.handleEvent(b)},false);this.container.addEventListener("touchend",function(b){b.preventDefault();a.touchEnd=true;a.handleEvent(b)},false)};Kinetic.Stage.prototype.getMousePos=function(a){return this.mousePos};Kinetic.Stage.prototype.getTouchPos=function(a){return this.touchPos};Kinetic.Stage.prototype.setMousePosition=function(a){var c=a.clientX-this.getContainerPos().left+window.pageXOffset;var b=a.clientY-this.getContainerPos().top+window.pageYOffset;this.mousePos={x:c,y:b}};Kinetic.Stage.prototype.setTouchPosition=function(c){if(c.touches!==undefined&&c.touches.length==1){var d=c.touches[0];var b=d.clientX-this.getContainerPos().left+window.pageXOffset;var a=d.clientY-this.getContainerPos().top+window.pageYOffset;this.touchPos={x:b,y:a}}};Kinetic.Stage.prototype.getContainerPos=function(){var c=this.container;var b=0;var a=0;while(c.tagName!="BODY"){b+=c.offsetTop;a+=c.offsetLeft;c=c.offsetParent}return{top:b,left:a}};Kinetic.Stage.prototype.getContainer=function(){return this.container};Kinetic.Stage.prototype.getShapes=function(){return(this.getPropsLayer().getShapes()).concat(this.getActorsLayer().getShapes())};Kinetic.Shape=function(b,a){this.drawFunc=b;this.isProp=a===undefined?false:a;this.x=0;this.y=0;this.scale={x:1,y:1};this.rotation=0;this.lastX=0;this.lastY=0;this.lastRotation=0;this.lastScale={x:1,y:1};this.eventListeners={};this.clickStart=false;this.inDblClickWindow=false;this.visible=true;this.drag={x:false,y:false}};Kinetic.Shape.prototype.getContext=function(){return this.tempLayer.getContext()};Kinetic.Shape.prototype.getCanvas=function(){return this.tempLayer.getCanvas()};Kinetic.Shape.prototype.getStage=function(){return this.stage};Kinetic.Shape.prototype.draw=function(c){if(this.visible){var a=this.getStage();var b=c.getContext();b.save();if(this.x!==0||this.y!==0){b.translate(this.x,this.y)}if(this.rotation!==0){b.rotate(this.rotation)}if(this.scale.x!=1||this.scale.y!=1){b.scale(this.scale.x,this.scale.y)}this.tempLayer=c;this.drawFunc.call(this);b.restore()}};Kinetic.Shape.prototype.initDrag=function(){var b=this;var a=["mousedown","touchstart"];for(var d=0;d<a.length;d++){var c=a[d];(function(){var e=c;b.on(e+".initdrag",function(f){var g=b.getStage();var l=e=="mousedown"?g.getMousePos():g.getTouchPos();if(l){g.shapeDragging=b;g.shapeDragging.offset={};g.shapeDragging.offset.x=l.x-b.x;g.shapeDragging.offset.y=l.y-b.y;var k=b.eventListeners.ondragstart;if(k){var j=k;for(var h=0;h<j.length;h++){j[h].func.apply(b,[f])}}}})})()}};Kinetic.Shape.prototype.dragCleanup=function(){if(!this.drag.x&&!this.drag.y){this.off("mousedown.initdrag");this.off("touchstart.initdrag")}};Kinetic.Shape.prototype.draggable=function(b){if(b){var a=!this.drag.x&&!this.drag.y;this.drag={x:true,y:true};if(a){this.initDrag()}}else{this.drag={x:false,y:false};this.dragCleanup()}};Kinetic.Shape.prototype.draggableX=function(b){if(b){var a=!this.drag.x&&!this.drag.y;this.drag.x=true;if(a){this.initDrag()}}else{this.drag.x=false;this.dragCleanup()}};Kinetic.Shape.prototype.draggableY=function(b){if(b){var a=!this.drag.x&&!this.drag.y;this.drag.y=true;if(a){this.initDrag()}}else{this.drag.y=false;this.dragCleanup()}};Kinetic.Shape.prototype.getZIndex=function(){return this.zIndex};Kinetic.Shape.prototype.setScale=function(a){this.scale.x=a;this.scale.y=a};Kinetic.Shape.prototype.scale=function(a){this.scale.x*=a;this.scale.y*=a};Kinetic.Shape.prototype.setPosition=function(a,b){this.x=a;this.y=b};Kinetic.Shape.prototype.move=function(a,b){this.x+=a;this.y+=b};Kinetic.Shape.prototype.setRotation=function(a){this.rotation=a};Kinetic.Shape.prototype.rotate=function(a){this.rotation+=a};Kinetic.Shape.prototype.on=function(c,e){var h=c.split(" ");for(var d=0;d<h.length;d++){var i=h[d];var b=(i.indexOf("touch")==-1)?"on"+i:i;var g=b.split(".");var f=g[0];var a=g.length>1?g[1]:"";if(!this.eventListeners[f]){this.eventListeners[f]=[]}this.eventListeners[f].push({name:a,func:e})}};Kinetic.Shape.prototype.addEventListener=function(a,b){this.on(a,b)};Kinetic.Shape.prototype.off=function(d){var e=(d.indexOf("touch")==-1)?"on"+d:d;var f=e.split(".");var b=f[0];if(this.eventListeners[b]&&f.length>1){var a=f[1];for(var c=0;c<this.eventListeners[b].length;c++){if(this.eventListeners[b][c].name==a){this.eventListeners[b].splice(c,1);if(this.eventListeners[b].length==0){this.eventListeners[b]=undefined}break}}}else{this.eventListeners[b]=undefined}};Kinetic.Shape.prototype.removeEventListener=function(a){this.off(a)};Kinetic.Shape.prototype.show=function(){this.visible=true};Kinetic.Shape.prototype.hide=function(){this.visible=false};Kinetic.Shape.prototype.moveToTop=function(){var c=this.stage;var d=this.getLayer();var a=d.getShapes();for(var e=0;e<a.length;e++){var b=a[e];if(b.id==this.id){d.shapes.splice(e,1);d.shapes.push(this);break}}d.setZIndices()};Kinetic.Shape.prototype.getLayer=function(){return this.layer};Kinetic.Shape.prototype.makeActor=function(){var c=this.stage;var d=this.getLayer();var f=c.getPropsLayer();var e=c.getActorsLayer();var a=d.getShapes();for(var g=0;g<a.length;g++){var b=a[g];if(b.id==this.id){d.shapes.splice(g,1);e.getShapes().push(this);this.layer=c.actorsLayer;break}}f.setZIndices();e.setZIndices()};Kinetic.Shape.prototype.makeProp=function(){var c=this.stage;var d=this.getLayer();var f=c.getPropsLayer();var e=c.getActorsLayer();var a=d.getShapes();for(var g=0;g<a.length;g++){var b=a[g];if(b.id==this.id){d.shapes.splice(g,1);f.getShapes().push(this);this.layer=c.propsLayer;break}}f.setZIndices();e.setZIndices()};Kinetic.Image=function(c,e){this.image=c.image;var g=c.x?c.x:0;var f=c.y?c.y:0;var b=c.width?c.width:c.image.width;var i=c.height?c.height:c.image.height;var a=function(){var j=this.getContext();j.drawImage(this.image,g,f,b,i);j.beginPath();j.rect(g,f,b,i);j.closePath()};var d=new Kinetic.Shape(a,e);for(var h in d){this[h]=d[h]}};Kinetic.Image.prototype.setImage=function(a){this.image=a;this.getStage().drawActors()};